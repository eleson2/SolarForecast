<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solar Forecast Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, sans-serif;
      background: #0f1117;
      color: #e0e0e0;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: #1a1d27;
      border-bottom: 1px solid #2a2d3a;
    }
    header h1 { font-size: 1.2rem; font-weight: 600; color: #fff; }
    #status { font-size: 0.8rem; color: #888; }
    #refresh-btn {
      background: #2a5caa;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    #refresh-btn:hover { background: #3a6cba; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 20px;
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: #1a1d27;
      border-radius: 10px;
      padding: 16px 20px;
      border: 1px solid #2a2d3a;
    }
    .card.wide { grid-column: 1 / -1; }

    .card h2 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 14px;
    }

    .chart-wrap { position: relative; height: 220px; }

    /* Battery schedule table */
    .schedule-table-wrap { overflow-x: auto; max-height: 340px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th {
      text-align: left;
      padding: 7px 10px;
      color: #888;
      border-bottom: 1px solid #2a2d3a;
      position: sticky;
      top: 0;
      background: #1a1d27;
      font-weight: 500;
    }
    td { padding: 6px 10px; border-bottom: 1px solid #1e2130; }
    tr:hover td { background: #20243a; }
    tr.now td { background: #1e3050; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.78rem;
      font-weight: 600;
    }
    .badge-charge    { background: #1a3a6a; color: #6ab0ff; }
    .badge-discharge { background: #3a1a1a; color: #ff8080; }
    .badge-sell      { background: #2a3a1a; color: #a0e080; }
    .badge-idle      { background: #2a2a2a; color: #888; }

    .summary-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .kpi { line-height: 1.3; }
    .kpi .val { font-size: 1.4rem; font-weight: 700; color: #fff; }
    .kpi .lbl { font-size: 0.75rem; color: #777; }
    .kpi .val.green { color: #6ae08a; }
    .kpi .val.red   { color: #ff8080; }
  </style>
</head>
<body>

<header>
  <h1>☀ Solar Forecast Dashboard</h1>
  <span id="status">Loading…</span>
  <button id="refresh-btn" onclick="loadAll()">Refresh</button>
</header>

<div class="grid">

  <!-- 1. Electricity prices -->
  <div class="card">
    <h2>Electricity Price — Next 48 h (SEK/kWh)</h2>
    <div class="chart-wrap"><canvas id="priceChart"></canvas></div>
  </div>

  <!-- 2. Solar irradiance forecast -->
  <div class="card">
    <h2>Solar Irradiance — Next 48 h (W/m²)</h2>
    <div class="chart-wrap"><canvas id="irrChart"></canvas></div>
  </div>

  <!-- 3. Actual vs forecast production last 7 days -->
  <div class="card">
    <h2>Solar Production — Last 7 Days (W actual vs forecast)</h2>
    <div class="chart-wrap"><canvas id="prodHistChart"></canvas></div>
  </div>

  <!-- 4. Irradiance history -->
  <div class="card">
    <h2>Solar Irradiance — Last 7 Days (W/m²)</h2>
    <div class="chart-wrap"><canvas id="irrHistChart"></canvas></div>
  </div>

  <!-- 5. Battery schedule -->
  <div class="card wide">
    <h2>Battery Schedule — Next 24 h</h2>
    <div class="summary-row" id="batterySummary"></div>
    <div class="schedule-table-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Action</th>
            <th>Battery W</th>
            <th>SOC start → end</th>
            <th>Price (SEK/kWh)</th>
            <th>Solar W</th>
            <th>Load W</th>
          </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
// --- Chart defaults ---
Chart.defaults.color = '#888';
Chart.defaults.borderColor = '#2a2d3a';
Chart.defaults.font.family = 'system-ui, sans-serif';
Chart.defaults.font.size = 11;

const CHART_OPTIONS = {
  responsive: true,
  maintainAspectRatio: false,
  animation: false,
  plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
  scales: {
    x: { grid: { color: '#1e2130' }, ticks: { maxTicksLimit: 12, maxRotation: 0 } },
    y: { grid: { color: '#1e2130' }, beginAtZero: true },
  },
};

function mergeOptions(...overrides) {
  return Object.assign({}, CHART_OPTIONS, ...overrides);
}

let charts = {};

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

function fmtTime(ts) {
  // ts is "YYYY-MM-DDTHH:MM" — show "Mon 14:00"
  const d = new Date(ts + ':00');
  return d.toLocaleString('sv-SE', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
}

function fmtHour(ts) {
  return ts.slice(11, 16); // "HH:MM"
}

// --- Price chart ---
async function loadPrices() {
  const data = await fetch('/api/prices').then(r => r.json());
  const prices = data.prices;

  // Aggregate 15-min slots to hourly average
  const byHour = {};
  for (const p of prices) {
    const h = p.slot_ts.slice(0, 13); // "YYYY-MM-DDTHH"
    if (!byHour[h]) byHour[h] = [];
    byHour[h].push(p.spot_price);
  }
  const labels = Object.keys(byHour).sort();
  const vals = labels.map(h => {
    const arr = byHour[h];
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  });

  const now = new Date();
  const nowHour = now.toISOString().slice(0, 13);
  const bgColors = labels.map(h => {
    const v = byHour[h].reduce((a, b) => a + b, 0) / byHour[h].length;
    if (h < nowHour) return 'rgba(80,80,80,0.4)';
    if (v < 0.5)  return 'rgba(60,180,100,0.7)';
    if (v < 1.0)  return 'rgba(255,200,60,0.7)';
    return 'rgba(220,70,70,0.7)';
  });

  destroyChart('price');
  const ctx = document.getElementById('priceChart').getContext('2d');
  charts.price = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels.map(h => fmtTime(h + ':00')),
      datasets: [{ data: vals, backgroundColor: bgColors, borderRadius: 3 }],
    },
    options: mergeOptions({
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: ctx => `${ctx.raw.toFixed(3)} SEK/kWh` }
        }
      }
    }),
  });
}

// --- Solar data (shared for charts 2–4) ---
let solarData = null;

async function loadSolar() {
  const data = await fetch('/api/solar').then(r => r.json());
  solarData = data.readings;

  const now = new Date();
  const nowTs = now.toISOString().slice(0, 13) + ':00';

  const future = solarData.filter(r => r.hour >= nowTs);
  const past    = solarData.filter(r => r.hour <  nowTs);

  // Chart 2: future irradiance
  destroyChart('irr');
  {
    const ctx = document.getElementById('irrChart').getContext('2d');
    charts.irr = new Chart(ctx, {
      type: 'line',
      data: {
        labels: future.map(r => fmtTime(r.hour)),
        datasets: [{
          data: future.map(r => r.irr_wm2),
          borderColor: '#f5c842',
          backgroundColor: 'rgba(245,200,66,0.15)',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 2,
        }],
      },
      options: mergeOptions(),
    });
  }

  // Chart 3: past production actual vs forecast
  destroyChart('prodHist');
  {
    const ctx = document.getElementById('prodHistChart').getContext('2d');
    charts.prodHist = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: past.map(r => fmtTime(r.hour)),
        datasets: [
          {
            label: 'Actual',
            data: past.map(r => r.prod_actual_w),
            backgroundColor: 'rgba(80,200,120,0.7)',
            borderRadius: 2,
          },
          {
            label: 'Forecast',
            data: past.map(r => r.prod_forecast_w),
            type: 'line',
            borderColor: '#6ab0ff',
            backgroundColor: 'transparent',
            pointRadius: 0,
            borderWidth: 1.5,
            borderDash: [4, 3],
          },
        ],
      },
      options: mergeOptions({ plugins: { legend: { display: true, labels: { color: '#aaa', boxWidth: 12 } } } }),
    });
  }

  // Chart 4: past irradiance history
  destroyChart('irrHist');
  {
    const ctx = document.getElementById('irrHistChart').getContext('2d');
    charts.irrHist = new Chart(ctx, {
      type: 'line',
      data: {
        labels: past.map(r => fmtTime(r.hour)),
        datasets: [{
          data: past.map(r => r.irr_wm2),
          borderColor: '#e08030',
          backgroundColor: 'rgba(224,128,48,0.12)',
          fill: true,
          tension: 0.3,
          pointRadius: 0,
          borderWidth: 1.5,
        }],
      },
      options: mergeOptions(),
    });
  }
}

// --- Battery schedule ---
async function loadSchedule() {
  const data = await fetch('/battery/schedule').then(r => r.json());
  const { schedule, summary } = data;

  // Summary KPIs
  const s = summary;
  const savings = s.estimated_savings;
  document.getElementById('batterySummary').innerHTML = `
    <div class="kpi"><div class="val">${s.estimated_cost_with_battery.toFixed(2)} SEK</div><div class="lbl">Cost with battery</div></div>
    <div class="kpi"><div class="val">${s.estimated_cost_without_battery.toFixed(2)} SEK</div><div class="lbl">Cost without battery</div></div>
    <div class="kpi"><div class="val ${savings >= 0 ? 'green' : 'red'}">${savings >= 0 ? '+' : ''}${savings.toFixed(2)} SEK</div><div class="lbl">Estimated savings (24 h)</div></div>
  `;

  const nowTs = new Date().toISOString().slice(0, 16);
  // Find the current slot (last slot <= now)
  let currentIdx = -1;
  for (let i = 0; i < schedule.length; i++) {
    if (schedule[i].slot <= nowTs) currentIdx = i;
  }

  const tbody = document.getElementById('scheduleBody');
  tbody.innerHTML = schedule.map((row, i) => {
    const badge = {
      charge_grid:  '<span class="badge badge-charge">Charge</span>',
      charge_solar: '<span class="badge badge-charge">Solar charge</span>',
      discharge:    '<span class="badge badge-discharge">Discharge</span>',
      sell:         '<span class="badge badge-sell">Sell</span>',
      idle:         '<span class="badge badge-idle">Idle</span>',
    }[row.action] ?? row.action;

    const isNow = i === currentIdx ? 'class="now"' : '';
    const watts = row.action === 'idle' ? '—' : `${row.watts}`;
    return `<tr ${isNow}>
      <td>${fmtTime(row.slot)}</td>
      <td>${badge}</td>
      <td>${watts}</td>
      <td>${row.soc_start ?? '—'}% → ${row.soc_end ?? '—'}%</td>
      <td>${row.price_kwh?.toFixed(3) ?? '—'}</td>
      <td>${row.solar_watts ?? 0}</td>
      <td>${row.consumption_watts ?? 0}</td>
    </tr>`;
  }).join('');

  // Scroll current slot into view
  const nowRow = tbody.querySelector('tr.now');
  if (nowRow) nowRow.scrollIntoView({ block: 'center' });
}

// --- Load all ---
async function loadAll() {
  const ts = new Date().toLocaleString('sv-SE');
  document.getElementById('status').textContent = 'Refreshing…';
  try {
    await Promise.all([loadPrices(), loadSolar(), loadSchedule()]);
    document.getElementById('status').textContent = `Updated ${ts}`;
  } catch (e) {
    document.getElementById('status').textContent = `Error: ${e.message}`;
    console.error(e);
  }
}

// Auto-refresh every 5 minutes
loadAll();
setInterval(loadAll, 5 * 60 * 1000);
</script>
</body>
</html>
